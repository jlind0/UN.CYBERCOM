@page "/"
@using UN.CYBERCOM.ViewModels
@using UN.CYBERCOM.Web.Helpers
@using UN.CYBERCOM.Contracts.CybercomDAO.ContractDefinition
@using System.Threading;
@inherits ReactiveInjectableComponentBase<CybercomViewModel>
@inject IJSRuntime JSRun
<PageTitle>UNofficial CYBERCOM</PageTitle>
<h3>UNofficial CYBERCOM</h3>
@if (ViewModel != null)
{
    <AlertView Alert="ViewModel.Alert" />
    @if(ViewModel.AccountNumber != null)
    {
        <h5>Wallet: @ViewModel.AccountNumber</h5>
        @if (ViewModel.IsLoading)
        {
            <p>Loading...</p>
        }
        else if (!ViewModel.IsDeployed)
        {
            <button type="button" @onclick="ViewModel.Deploy.BindCommand<MouseEventArgs>()">Deploy</button>
        }
        else
        {
            <p>Contract: @ViewModel.ContractAddress</p>
            <p>Voting: @ViewModel.VotingAddress</p>
            <p>Council Management: @ViewModel.CouncilManagerAddress</p>
            <button @onclick="ViewModel.Load.BindCommand<MouseEventArgs>()" type="button">Reload</button>
            <AddMembershipView ViewModel="ViewModel.AddMembershipVM"/>
            <h2>Nations</h2>
            <TelerikGrid Data="ViewModel.Nations">
                <GridColumns>
                    <GridColumn Field="@nameof(NationViewModel.Id)" Title="Address" />
                    <GridColumn Field="@nameof(NationViewModel.Name)" Title="Name" />
                    <GridColumn Title="Actions">
                        <Template>
                            <button class="btn btn-primary" @onclick="((NationViewModel)context).Remove.BindCommand<MouseEventArgs>()"><i class="fa-solid fa-trash-xmark"></i></button>
                        </Template>
                    </GridColumn>
                </GridColumns>
            </TelerikGrid>
            <TelerikTabStrip>
                <TabStripTab Title="Membership Requests">
                    <h2>Entered Membership Requests</h2>
                    <TelerikGrid Data="ViewModel.EnteredMembershipProposals">
                        <GridColumns>
                            <GridColumn Field="Id" Title="Id" />
                            <GridColumn Field="NewNation.Id" Title="Nation Address" />
                            <GridColumn Field="NewNation.Name" Title="Nation Name" />
                            <GridColumn>
                                <Template>
                                    @if (((MembershipProposalViewModel)context).CanStartVoting)
                                    {
                                        <TelerikButton OnClick="((MembershipProposalViewModel)context).StartVoting.BindCommand<MouseEventArgs>()">Start Voting</TelerikButton>
                                        <AddDocumentView ViewModel="((ProposalViewModel)context).AddDocumentVM" />


                                    }
                                    <ul>
                                        @foreach (var doc in ((ProposalViewModel)context).Documents)
                                        {
                                            <li>
                                                <a href="@doc.Url" target="_blank">@doc.Title</a>
                                                <p>Document Hash: @doc.DocumentHash <TelerikButton OnClick="doc.VerifyDocumentHash.BindCommand<MouseEventArgs>()">Verify Hash</TelerikButton> Verified: @doc.DocumentHashIsValid</p>
                                                <p>Signature: @doc.Signature</p>
                                                <p>Signer: @doc.Signer</p>
                                                <p>Document Address: @doc.Address</p>
                                            </li>
                                        }
                                    </ul>
                                </Template>
                            </GridColumn>
                        </GridColumns>
                    </TelerikGrid>
                    <h2>Pending Membership Requests</h2>
                    <TelerikGrid Data="ViewModel.PendingMembershipProposals">
                        <GridColumns>
                            <GridColumn Field="Id" Title="Id" />
                            <GridColumn Field="NewNation.Id" Title="Nation Address" />
                            <GridColumn Field="NewNation.Name" Title="Nation Name" />
                            <GridColumn Field="Duration" Title="Voting Experation Date" />
                            <GridColumn>
                                <Template>
                                    @if (((MembershipProposalViewModel)context).CanTally)
                                    {
                                        <TelerikButton OnClick="((MembershipProposalViewModel)context).Tally.BindCommand<MouseEventArgs>()">Tally</TelerikButton>
                                    }
                                    <ProposalVoteView ViewModel="(ProposalViewModel)context" />
                                    <ul>
                                        @foreach (var doc in ((ProposalViewModel)context).Documents)
                                        {
                                            <li>
                                                <a href="@doc.Url" target="_blank">@doc.Title</a>
                                                <p>Document Hash: @doc.DocumentHash <TelerikButton OnClick="doc.VerifyDocumentHash.BindCommand<MouseEventArgs>()">Verify Hash</TelerikButton> Verified: @doc.DocumentHashIsValid</p>
                                                <p>Signature: @doc.Signature</p>
                                                <p>Signer: @doc.Signer</p>
                                                <p>Document Address: @doc.Address</p>
                                            </li>
                                        }
                                    </ul>
                                </Template>
                            </GridColumn>
                        </GridColumns>
                    </TelerikGrid>
                    <h2>Ready for Final Tally</h2>
                    <TelerikGrid Data="ViewModel.ReadyMembershipProposals">
                        <GridColumns>
                            <GridColumn Field="Id" Title="Id" />
                            <GridColumn Field="NewNation.Id" Title="Nation Address" />
                            <GridColumn Field="NewNation.Name" Title="Nation Name" />
                            <GridColumn Field="Duration" Title="Voting Experation Date" />
                            <GridColumn>
                                <Template>
                                    @if (((MembershipProposalViewModel)context).CanCompleteTally)
                                    {
                                        <TelerikButton OnClick="((MembershipProposalViewModel)context).CompleteTally.BindCommand<MouseEventArgs>()">Complete</TelerikButton>
                                    }
                                    <ProposalVoteView ViewModel="(ProposalViewModel)context" />
                                    <ul>
                                        @foreach (var doc in ((ProposalViewModel)context).Documents)
                                        {
                                            <li>
                                                <a href="@doc.Url" target="_blank">@doc.Title</a>
                                                <p>Document Hash: @doc.DocumentHash <TelerikButton OnClick="doc.VerifyDocumentHash.BindCommand<MouseEventArgs>()">Verify Hash</TelerikButton> Verified: @doc.DocumentHashIsValid</p>
                                                <p>Signature: @doc.Signature</p>
                                                <p>Signer: @doc.Signer</p>
                                                <p>Document Address: @doc.Address</p>
                                            </li>
                                        }
                                    </ul>
                                </Template>
                            </GridColumn>
                        </GridColumns>
                    </TelerikGrid>
                    <h2>Rejected</h2>
                    <TelerikGrid Data="ViewModel.RejectedMembershipProposals">
                        <GridColumns>
                            <GridColumn Field="Id" Title="Id" />
                            <GridColumn Field="NewNation.Id" Title="Nation Address" />
                            <GridColumn Field="NewNation.Name" Title="Nation Name" />
                            <GridColumn Field="Duration" Title="Voting Experation Date" />
                            <GridColumn>
                                <Template>
                                    <ProposalVoteView ViewModel="(ProposalViewModel)context" />
                                    <ul>
                                        @foreach (var doc in ((ProposalViewModel)context).Documents)
                                        {
                                            <li>
                                                <a href="@doc.Url" target="_blank">@doc.Title</a>
                                                <p>Document Hash: @doc.DocumentHash <TelerikButton OnClick="doc.VerifyDocumentHash.BindCommand<MouseEventArgs>()">Verify Hash</TelerikButton> Verified: @doc.DocumentHashIsValid</p>
                                                <p>Signature: @doc.Signature</p>
                                                <p>Signer: @doc.Signer</p>
                                                <p>Document Address: @doc.Address</p>
                                            </li>
                                        }
                                    </ul>
                                </Template>
                            </GridColumn>
                        </GridColumns>
                    </TelerikGrid>
                    <h2>Approved</h2>
                    <TelerikGrid Data="ViewModel.ApprovedMembershipProposals">
                        <GridColumns>
                            <GridColumn Field="Id" Title="Id" />
                            <GridColumn Field="NewNation.Id" Title="Nation Address" />
                            <GridColumn Field="NewNation.Name" Title="Nation Name" />
                            <GridColumn Field="Duration" Title="Voting Experation Date" />
                            <GridColumn>
                                <Template>
                                    <ProposalVoteView ViewModel="(ProposalViewModel)context" />
                                    <ul>
                                        @foreach (var doc in ((ProposalViewModel)context).Documents)
                                        {
                                            <li>
                                                <a href="@doc.Url" target="_blank">@doc.Title</a>
                                                <p>Document Hash: @doc.DocumentHash <TelerikButton OnClick="doc.VerifyDocumentHash.BindCommand<MouseEventArgs>()">Verify Hash</TelerikButton> Verified: @doc.DocumentHashIsValid</p>
                                                <p>Signature: @doc.Signature</p>
                                                <p>Signer: @doc.Signer</p>
                                                <p>Document Address: @doc.Address</p>
                                            </li>
                                        }
                                    </ul>
                                </Template>
                            </GridColumn>
                        </GridColumns>
                    </TelerikGrid>
                </TabStripTab>
                <TabStripTab Title="Membership Removal Requests">
                    <h2>Entered Membership Requests</h2>
                    <TelerikGrid Data="ViewModel.EnteredMembershipRemovalProposals">
                        <GridColumns>
                            <GridColumn Field="Id" Title="Id" />
                            <GridColumn Field="NationToRemove.Id" Title="Nation Address" />
                            <GridColumn Field="NationToRemove.Name" Title="Nation Name" />
                            <GridColumn>
                                <Template>
                                    @if (((MembershipRemovalProposalViewModel)context).CanStartVoting)
                                    {
                                        <TelerikButton OnClick="((MembershipRemovalProposalViewModel)context).StartVoting.BindCommand<MouseEventArgs>()">Start Voting</TelerikButton>
                                        <AddDocumentView ViewModel="((ProposalViewModel)context).AddDocumentVM" />


                                    }
                                    <ul>
                                        @foreach (var doc in ((ProposalViewModel)context).Documents)
                                        {
                                            <li>
                                                <a href="@doc.Url" target="_blank">@doc.Title</a>
                                                <p>Document Hash: @doc.DocumentHash <TelerikButton OnClick="doc.VerifyDocumentHash.BindCommand<MouseEventArgs>()">Verify Hash</TelerikButton> Verified: @doc.DocumentHashIsValid</p>
                                                <p>Signature: @doc.Signature</p>
                                                <p>Signer: @doc.Signer</p>
                                                <p>Document Address: @doc.Address</p>
                                            </li>
                                        }
                                    </ul>
                                </Template>
                            </GridColumn>
                        </GridColumns>
                    </TelerikGrid>
                    <h2>Pending Membership Requests</h2>
                    <TelerikGrid Data="ViewModel.PendingMembershipRemovalProposals">
                        <GridColumns>
                            <GridColumn Field="Id" Title="Id" />
                            <GridColumn Field="NationToRemove.Id" Title="Nation Address" />
                            <GridColumn Field="NationToRemove.Name" Title="Nation Name" />
                            <GridColumn Field="Duration" Title="Voting Experation Date" />
                            <GridColumn>
                                <Template>
                                    @if (((MembershipRemovalProposalViewModel)context).CanTally)
                                    {
                                        <TelerikButton OnClick="((MembershipRemovalProposalViewModel)context).Tally.BindCommand<MouseEventArgs>()">Tally</TelerikButton>
                                    }
                                    <ProposalVoteView ViewModel="(ProposalViewModel)context" />
                                    <ul>
                                        @foreach (var doc in ((ProposalViewModel)context).Documents)
                                        {
                                            <li>
                                                <a href="@doc.Url" target="_blank">@doc.Title</a>
                                                <p>Document Hash: @doc.DocumentHash <TelerikButton OnClick="doc.VerifyDocumentHash.BindCommand<MouseEventArgs>()">Verify Hash</TelerikButton> Verified: @doc.DocumentHashIsValid</p>
                                                <p>Signature: @doc.Signature</p>
                                                <p>Signer: @doc.Signer</p>
                                                <p>Document Address: @doc.Address</p>
                                            </li>
                                        }
                                    </ul>
                                </Template>
                            </GridColumn>
                        </GridColumns>
                    </TelerikGrid>
                    <h2>Ready for Final Tally</h2>
                    <TelerikGrid Data="ViewModel.ReadyMembershipRemovalProposals">
                        <GridColumns>
                            <GridColumn Field="Id" Title="Id" />
                            <GridColumn Field="NationToRemove.Id" Title="Nation Address" />
                            <GridColumn Field="NationToRemove.Name" Title="Nation Name" />
                            <GridColumn Field="Duration" Title="Voting Experation Date" />
                            <GridColumn>
                                <Template>
                                    @if (((MembershipRemovalProposalViewModel)context).CanCompleteTally)
                                    {
                                        <TelerikButton OnClick="((MembershipRemovalProposalViewModel)context).CompleteTally.BindCommand<MouseEventArgs>()">Complete</TelerikButton>
                                    }
                                    <ProposalVoteView ViewModel="(ProposalViewModel)context" />
                                    <ul>
                                        @foreach (var doc in ((ProposalViewModel)context).Documents)
                                        {
                                            <li>
                                                <a href="@doc.Url" target="_blank">@doc.Title</a>
                                                <p>Document Hash: @doc.DocumentHash <TelerikButton OnClick="doc.VerifyDocumentHash.BindCommand<MouseEventArgs>()">Verify Hash</TelerikButton> Verified: @doc.DocumentHashIsValid</p>
                                                <p>Signature: @doc.Signature</p>
                                                <p>Signer: @doc.Signer</p>
                                                <p>Document Address: @doc.Address</p>
                                            </li>
                                        }
                                    </ul>
                                </Template>
                            </GridColumn>
                        </GridColumns>
                    </TelerikGrid>
                    <h2>Rejected</h2>
                    <TelerikGrid Data="ViewModel.RejectedMembershipRemovalProposals">
                        <GridColumns>
                            <GridColumn Field="Id" Title="Id" />
                            <GridColumn Field="NationToRemove.Id" Title="Nation Address" />
                            <GridColumn Field="NationToRemove.Name" Title="Nation Name" />
                            <GridColumn Field="Duration" Title="Voting Experation Date" />
                            <GridColumn>
                                <Template>
                                    <ProposalVoteView ViewModel="(ProposalViewModel)context" />
                                    <ul>
                                        @foreach (var doc in ((ProposalViewModel)context).Documents)
                                        {
                                            <li>
                                                <a href="@doc.Url" target="_blank">@doc.Title</a>
                                                <p>Document Hash: @doc.DocumentHash <TelerikButton OnClick="doc.VerifyDocumentHash.BindCommand<MouseEventArgs>()">Verify Hash</TelerikButton> Verified: @doc.DocumentHashIsValid</p>
                                                <p>Signature: @doc.Signature</p>
                                                <p>Signer: @doc.Signer</p>
                                                <p>Document Address: @doc.Address</p>
                                            </li>
                                        }
                                    </ul>
                                </Template>
                            </GridColumn>
                        </GridColumns>
                    </TelerikGrid>
                    <h2>Approved</h2>
                    <TelerikGrid Data="ViewModel.ApprovedMembershipRemovalProposals">
                        <GridColumns>
                            <GridColumn Field="Id" Title="Id" />
                            <GridColumn Field="NationToRemove.Id" Title="Nation Address" />
                            <GridColumn Field="NationToRemove.Name" Title="Nation Name" />
                            <GridColumn Field="Duration" Title="Voting Experation Date" />
                            <GridColumn>
                                <Template>
                                    <ProposalVoteView ViewModel="(ProposalViewModel)context" />
                                    <ul>
                                        @foreach (var doc in ((ProposalViewModel)context).Documents)
                                        {
                                            <li>
                                                <a href="@doc.Url" target="_blank">@doc.Title</a>
                                                <p>Document Hash: @doc.DocumentHash <TelerikButton OnClick="doc.VerifyDocumentHash.BindCommand<MouseEventArgs>()">Verify Hash</TelerikButton> Verified: @doc.DocumentHashIsValid</p>
                                                <p>Signature: @doc.Signature</p>
                                                <p>Signer: @doc.Signer</p>
                                                <p>Document Address: @doc.Address</p>
                                            </li>
                                        }
                                    </ul>
                                </Template>
                            </GridColumn>
                        </GridColumns>
                    </TelerikGrid>
                </TabStripTab>
            </TelerikTabStrip>
            
        }
    }
}
@code {
    protected SemaphoreSlim Slim { get; } = new SemaphoreSlim(0);
    protected SemaphoreSlim Slim2 { get; } = new SemaphoreSlim(0);
    protected string? SignedDocHash{ get; set; }
    protected string? SignedData{ get; set; }
    protected override Task OnInitializedAsync()
    {
        ViewModel.SignatureRequest.RegisterHandler(async data =>
        {
            await JSRun.InvokeVoidAsync("signTransaction", ViewModel.AccountNumber, data.Input.ContractAddress, data.Input.TXData, nameof(CallMemberRequestFin));
            await Slim.WaitAsync();
            data.SetOutput(SignedData ?? throw new InvalidDataException());
            SignedData = null;
        });
        ViewModel.SignData.RegisterHandler(async data =>
        {
            await JSRun.InvokeVoidAsync("signHash", ViewModel.AccountNumber, data.Input, nameof(CallDocHashFin));
            await Slim2.WaitAsync();
            data.SetOutput(SignedDocHash ?? throw new InvalidOperationException());
            SignedDocHash = null;
        });
        return base.OnInitializedAsync();
    }
    [JSInvokable("SetAccount")]
    public async Task SetAccount(string accountNumber)
    {
        ViewModel.AccountNumber = accountNumber;
    }
    [JSInvokable("CallMemberRequestFin")]
    public Task CallMemberRequestFin(string signedData)
    {
        SignedData = signedData;
        Slim.Release();
        return Task.CompletedTask;
    }
    [JSInvokable("CallDocHashFin")]
    public Task CallDocHashFin(string signedData)
    {
        SignedDocHash = signedData;
        Slim2.Release();
        return Task.CompletedTask;
    }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);
        if (firstRender)
        {
            var dotNetReference = DotNetObjectReference.Create(this);
            await JSRun.InvokeVoidAsync("SetDotNetObject", dotNetReference);
        }
    }
}
